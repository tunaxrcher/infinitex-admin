<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏î‡∏µ - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏ó‡∏¢</title>
    <!-- Mapbox GL JS v3 - 3D ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <link rel="stylesheet" href="style.css" />
    <style>
      /* Selected province badge */
      .selected-province-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--primary-color);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        margin-bottom: 12px;
      }
      .selected-province-badge .clear-btn {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
      }
      .selected-province-badge .clear-btn:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      /* üåü Mapbox controls styling */
      .mapboxgl-ctrl-group {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px);
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
        overflow: hidden;
      }

      .mapboxgl-ctrl-group button {
        width: 36px !important;
        height: 36px !important;
      }

      .mapboxgl-ctrl-group button:hover {
        background-color: rgba(0, 0, 0, 0.05) !important;
      }

      /* 3D mode indicator */
      .mode-3d-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
      }

      /* Attribution styling */
      .mapboxgl-ctrl-attrib {
        background: rgba(255, 255, 255, 0.8) !important;
        border-radius: 8px !important;
        padding: 4px 8px !important;
        font-size: 10px !important;
      }

      /* ==================== FILTER PANEL ==================== */
      .filter-panel {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 20px;
        z-index: 1000;
        animation: slideDown 0.3s ease;
      }
      .filter-panel.active {
        display: block;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .filter-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .filter-group {
        flex: 1;
        min-width: 200px;
      }
      .filter-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 6px;
      }
      .filter-group select,
      .filter-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
      }
      .price-range {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .price-range input {
        flex: 1;
      }
      .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 12px;
        border-top: 1px solid #eee;
      }
      .btn-filter {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-filter.primary {
        background: var(--primary-color);
        color: white;
        border: none;
      }
      .btn-filter.secondary {
        background: white;
        color: #666;
        border: 1px solid #ddd;
      }

      /* ==================== PROVINCE STATS TOOLTIP ==================== */
      .province-stats-tooltip {
        position: absolute;
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        pointer-events: none;
        min-width: 200px;
        display: none;
      }
      .province-stats-tooltip.active {
        display: block;
      }
      .province-stats-tooltip h4 {
        margin: 0 0 12px 0;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .province-stats-tooltip .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
      }
      .province-stats-tooltip .stat-row:last-child {
        border: none;
      }
      .province-stats-tooltip .stat-label {
        color: #888;
      }
      .province-stats-tooltip .stat-value {
        font-weight: 600;
        color: #333;
      }
      .province-stats-tooltip .stat-value.highlight {
        color: var(--primary-color);
      }

      /* ==================== CLUSTER MARKERS ==================== */
      .cluster-marker {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        border: 3px solid white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .cluster-marker:hover {
        transform: scale(1.15);
      }
      .cluster-marker.small {
        width: 40px;
        height: 40px;
      }
      .cluster-marker.medium {
        width: 50px;
        height: 50px;
        font-size: 15px;
      }
      .cluster-marker.large {
        width: 60px;
        height: 60px;
        font-size: 16px;
      }

      /* ==================== FAVORITES ==================== */
      .favorite-btn {
        transition: all 0.2s;
      }
      .favorite-btn.active {
        color: #e91e63 !important;
      }
      .favorite-btn.active i {
        color: #e91e63;
      }

      /* ==================== IMAGE GALLERY MODAL ==================== */
      .gallery-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }
      .gallery-modal.active {
        display: flex;
      }
      .gallery-content {
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
      }
      .gallery-content img {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 8px;
      }
      .gallery-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 24px;
      }
      .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .gallery-nav.prev {
        left: 20px;
      }
      .gallery-nav.next {
        right: 20px;
      }
      .gallery-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        padding: 40px 20px 20px;
      }
      .gallery-info h3 {
        margin: 0 0 8px 0;
      }
      .gallery-info p {
        margin: 0;
        opacity: 0.8;
      }

      /* ==================== SEARCH SUGGESTIONS ==================== */
      .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
      }
      .search-suggestions.active {
        display: block;
      }
      .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f0f0f0;
      }
      .suggestion-item:hover {
        background: #f5f5f5;
      }
      .suggestion-item i {
        color: #888;
      }
      .suggestion-item .title {
        font-weight: 500;
      }
      .suggestion-item .subtitle {
        font-size: 12px;
        color: #888;
      }

      /* ==================== DISPLAY SETTINGS ==================== */
      .display-settings-btn {
        position: absolute;
        bottom: 80px;
        left: 10px;
        background: white;
        border: none;
        border-radius: 12px;
        padding: 10px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.2s;
        z-index: 10;
      }
      .display-settings-btn:hover {
        background: #f5f5f5;
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .display-settings-panel {
        position: absolute;
        bottom: 130px;
        left: 10px;
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 100;
        min-width: 280px;
        display: none;
        animation: slideUp 0.3s ease;
      }
      .display-settings-panel.active {
        display: block;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .settings-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .settings-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #888;
      }

      .settings-section {
        margin-bottom: 16px;
      }
      .settings-section:last-child {
        margin-bottom: 0;
      }
      .settings-label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 8px;
        display: block;
      }

      .style-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .style-option {
        background: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
      }
      .style-option:hover {
        background: #eee;
      }
      .style-option.active {
        border-color: var(--primary-color);
        background: rgba(211, 47, 47, 0.1);
      }
      .style-option i {
        font-size: 24px;
        margin-bottom: 4px;
        display: block;
      }
      .style-option span {
        font-size: 11px;
        font-weight: 500;
      }

      .preset-options {
        display: flex;
        gap: 6px;
      }
      .preset-option {
        flex: 1;
        background: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 8px 4px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        font-size: 10px;
        font-weight: 500;
      }
      .preset-option:hover {
        background: #eee;
      }
      .preset-option.active {
        border-color: var(--primary-color);
        background: rgba(211, 47, 47, 0.1);
      }
      .preset-option i {
        font-size: 16px;
        display: block;
        margin-bottom: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->

    <!-- Main Content -->
    <div class="main-container">
      <!-- Left Side: Listings -->
      <div class="listings-container">
        <div class="listings-header">
          <div class="tabs">
            <button class="tab active">
              <i class="material-icons">home_work</i>
              <span>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
            </button>
            <button class="tab">
              <i class="material-icons">map</i>
              <span>‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
            </button>
          </div>

          <!-- Selected Province Badge -->
          <div id="selected-province-container"></div>

          <p class="result-count">
            ‡πÄ‡∏à‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            <strong id="result-count-num">0 ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</strong>
          </p>
        </div>

        <div class="listings-grid" id="listings-grid">
          <!-- Javascript will populate this -->
        </div>
        <div class="pagination">
          <button disabled>
            <i class="material-icons">navigate_before</i>
          </button>
          <button class="active">1</button>
          <button>2</button>
          <button><i class="material-icons">navigate_next</i></button>
        </div>
      </div>

      <!-- Right Side: Map -->
      <div class="map-container" style="position: relative">
        <div id="map"></div>

        <!-- 3D Mode Badge -->
        <div class="mode-3d-badge">
          <i class="material-icons" style="font-size: 14px">3d_rotation</i>
          <span>3D Mode</span>
        </div>

        <!-- Province Stats Tooltip -->
        <div class="province-stats-tooltip" id="province-stats-tooltip">
          <h4>
            <i
              class="material-icons"
              style="font-size: 18px; color: var(--primary-color)"
              >location_city</i
            >
            <span id="stats-province-name">-</span>
          </h4>
          <div class="stat-row">
            <span class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</span>
            <span class="stat-value highlight" id="stats-count">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>
            <span class="stat-value" id="stats-avg">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</span>
            <span class="stat-value" id="stats-min">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
            <span class="stat-value" id="stats-max">-</span>
          </div>
        </div>

        <!-- Display Settings -->
        <button class="display-settings-btn" id="display-settings-btn">
          <i class="material-icons" style="font-size: 18px">tune</i>
          <span>Display Settings</span>
        </button>

        <div class="display-settings-panel" id="display-settings-panel">
          <div class="settings-header">
            <h3>
              <i class="material-icons" style="font-size: 20px">settings</i>
              Display Settings
            </h3>
            <button class="settings-close" id="settings-close">
              <i class="material-icons">close</i>
            </button>
          </div>

          <!-- Map Style -->
          <div class="settings-section">
            <span class="settings-label">üó∫Ô∏è Map Style</span>
            <div class="style-options">
              <div class="style-option active" data-style="standard">
                <i class="material-icons">map</i>
                <span>Standard</span>
              </div>
              <div class="style-option" data-style="satellite">
                <i class="material-icons">satellite_alt</i>
                <span>Satellite</span>
              </div>
            </div>
          </div>

          <!-- Light Preset -->
          <div class="settings-section">
            <span class="settings-label">üí° Light Preset</span>
            <div class="preset-options">
              <div class="preset-option" data-preset="dawn">
                <i class="material-icons">wb_twilight</i>
                Dawn
              </div>
              <div class="preset-option" data-preset="day">
                <i class="material-icons">light_mode</i>
                Day
              </div>
              <div class="preset-option" data-preset="dusk">
                <i class="material-icons">nights_stay</i>
                Dusk
              </div>
              <div class="preset-option active" data-preset="night">
                <i class="material-icons">dark_mode</i>
                Night
              </div>
            </div>
          </div>
        </div>

        <!-- Map Controls -->
        <div class="map-controls-bottom">
          <button class="map-btn-primary" id="btn-reset-view">
            <i class="material-icons">refresh</i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
          </button>
          <div class="map-btn-group">
            <button class="map-btn-icon" id="btn-zoom-in">
              <i class="material-icons">add</i>
            </button>
            <button class="map-btn-icon" id="btn-zoom-out">
              <i class="material-icons">remove</i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Gallery Modal -->
    <div class="gallery-modal" id="gallery-modal">
      <button class="gallery-close" onclick="closeGallery()">
        <i class="material-icons">close</i>
      </button>
      <button class="gallery-nav prev" onclick="prevImage()">
        <i class="material-icons">chevron_left</i>
      </button>
      <div class="gallery-content">
        <img id="gallery-image" src="" alt="" />
        <div class="gallery-info">
          <h3 id="gallery-title"></h3>
          <p id="gallery-location"></p>
          <p
            id="gallery-price"
            style="font-size: 20px; font-weight: 600; margin-top: 8px"
          ></p>
        </div>
      </div>
      <button class="gallery-nav next" onclick="nextImage()">
        <i class="material-icons">chevron_right</i>
      </button>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
      <div class="chatbot-messages" style="display: none">
        <div class="chatbot-header">
          <span>‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠</span>
          <button class="close-chat">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="messages-list">
          <div class="message bot">
            <div class="avatar">
              <img src="https://via.placeholder.com/36" alt="bot" />
            </div>
            <div class="bubble">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡πÄ‡∏≠‡∏á‡∏Ñ‡πà‡∏≤! ‚ù§Ô∏è‚ú®</div>
          </div>
          <div class="message bot">
            <div class="avatar">
              <img src="https://via.placeholder.com/36" alt="bot" />
            </div>
            <div class="bubble">‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏Ñ‡∏∞?</div>
          </div>
        </div>
        <div class="chat-input">
          <input type="text" placeholder="‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞" />
          <button disabled><i class="material-icons">send</i></button>
        </div>
      </div>
      <button class="chatbot-toggle">
        <i class="material-icons" style="font-size: 32px; color: white"
          >chat_bubble</i
        >
      </button>
    </div>

    <script src="mockData.js"></script>
    <script>
      // ==================== CONFIG ====================
      const MAPBOX_TOKEN =
        'pk.eyJ1IjoidGhhbnVzaW5sZXJ0IiwiYSI6ImNta2t3NjAyOTFuNWUzZHB2bmJyZTY3MGsifQ.BMVmI5aXT-DifXv0_gpOGw';
      const THAILAND_PROVINCES_URL =
        'https://raw.githubusercontent.com/apisit/thailand.json/master/thailand.json';

      // ==================== GLOBAL STATE ====================
      let map;
      let hoveredProvinceId = null;
      let selectedProvinceId = null;
      let selectedProvinceName = null;
      let provincesData = null;
      let markers = {};
      let currentMapStyle = 'standard'; // 'standard' or 'satellite'
      let currentLightPreset = 'night'; // 'dawn', 'day', 'dusk', 'night'
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      let currentGalleryProperty = null;
      let currentImageIndex = 0;
      let filteredProperties = [...properties];

      // ==================== INITIALIZE ====================
      document.addEventListener('DOMContentLoaded', () => {
        renderListings(properties);
        updateResultCount(properties.length);
        initMap();
        initChatbot();
        initControls();
        initSearch();
        initFilter();
      });

      // ==================== MAP INITIALIZATION ====================
      function initMap() {
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // ‡πÉ‡∏ä‡πâ Style ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á (upload ‡∏à‡∏≤‡∏Å style.json ‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö)
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/standard',
          config: {
            basemap: {
              lightPreset: 'night',
              theme: 'faded',
            },
          },
          center: [100.5, 13.5],
          zoom: 5.5,
          minZoom: 4,
          maxZoom: 18,
          pitch: 45, // üéØ ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 45 ‡∏≠‡∏á‡∏®‡∏≤
          bearing: -10, // üéØ ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
          antialias: true, // üéØ ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô
          // V3 Enhanced
          performanceMetricsCollection: false,
        });

        window.map = map;

        // üéÆ ‡πÄ‡∏û‡∏¥‡πà‡∏° Navigation Controls
        map.addControl(
          new mapboxgl.NavigationControl({
            visualizePitch: true, // ‡πÅ‡∏™‡∏î‡∏á pitch indicator
          }),
          'top-right',
        );

        // üì∫ ‡πÄ‡∏û‡∏¥‡πà‡∏° Fullscreen Control
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

        // üìç ‡πÄ‡∏û‡∏¥‡πà‡∏° Geolocate Control
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true,
          }),
          'top-right',
        );

        // üìè ‡πÄ‡∏û‡∏¥‡πà‡∏° Scale
        map.addControl(
          new mapboxgl.ScaleControl({
            maxWidth: 100,
            unit: 'metric',
          }),
          'bottom-right',
        );

        map.on('load', () => {
          // ==================== üèîÔ∏è 3D TERRAIN ====================
          map.addSource('mapbox-dem', {
            type: 'raster-dem',
            url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
            tileSize: 512,
            maxzoom: 14,
          });

          map.setTerrain({
            source: 'mapbox-dem',
            exaggeration: 2.0, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤ (‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
          });

          // ==================== üåÖ SKY LAYER ====================
          map.addLayer({
            id: 'sky',
            type: 'sky',
            paint: {
              'sky-type': 'atmosphere',
              'sky-atmosphere-sun': [0.0, 90.0],
              'sky-atmosphere-sun-intensity': 15,
            },
          });

          // ==================== üè¢ 3D BUILDINGS (V3 Enhanced) ====================
          // ‡∏´‡∏≤ layer ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏™‡πà 3D buildings ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ï‡πâ
          const layers = map.getStyle().layers;
          const labelLayerId = layers.find(
            (layer) =>
              layer.type === 'symbol' &&
              layer.layout &&
              layer.layout['text-field'],
          )?.id;

          map.addLayer(
            {
              id: '3d-buildings',
              source: 'composite',
              'source-layer': 'building',
              filter: ['==', 'extrude', 'true'],
              type: 'fill-extrusion',
              minzoom: 13,
              paint: {
                'fill-extrusion-color': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  '#ff9800', // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover
                  [
                    'interpolate',
                    ['linear'],
                    ['get', 'height'],
                    0,
                    '#d4d4d4',
                    30,
                    '#c0c0c0',
                    60,
                    '#a8a8a8',
                    100,
                    '#909090',
                  ],
                ],
                'fill-extrusion-height': ['get', 'height'],
                'fill-extrusion-base': ['get', 'min_height'],
                'fill-extrusion-opacity': 0.85,
                'fill-extrusion-vertical-gradient': true,
              },
            },
            labelLayerId,
          );

          // ==================== ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ====================
          const labelLayers = map
            .getStyle()
            .layers.filter(
              (layer) => layer.type === 'symbol' && layer.id.includes('label'),
            );

          labelLayers.forEach((layer) => {
            try {
              map.setLayoutProperty(layer.id, 'text-field', [
                'coalesce',
                ['get', 'name_th'],
                ['get', 'name_en'],
                ['get', 'name'],
              ]);
            } catch (e) {
              // ‡∏ö‡∏≤‡∏á layer ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
            }
          });

          loadProvinces();
          addPropertyMarkers();
          initDisplaySettings();
        });
      }

      // ==================== THAI PROVINCE NAMES MAP ====================
      const PROVINCE_NAMES_TH = {
        'Amnat Charoen': '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç',
        'Ang Thong': '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á',
        Bangkok: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        'Bangkok Metropolis': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        'Bueng Kan': '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨',
        'Buri Ram': '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå',
        Buriram: '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå',
        Chachoengsao: '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤',
        'Chai Nat': '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó',
        Chaiyaphum: '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥',
        Chanthaburi: '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ',
        'Chiang Mai': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        'Chiang Rai': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',
        'Chon Buri': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
        Chonburi: '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
        Chumphon: '‡∏ä‡∏∏‡∏°‡∏û‡∏£',
        Kalasin: '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå',
        'Kamphaeng Phet': '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£',
        Kanchanaburi: '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ',
        'Khon Kaen': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',
        Krabi: '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà',
        Lampang: '‡∏•‡∏≥‡∏õ‡∏≤‡∏á',
        Lamphun: '‡∏•‡∏≥‡∏û‡∏π‡∏ô',
        Loei: '‡πÄ‡∏•‡∏¢',
        'Lop Buri': '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ',
        Lopburi: '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ',
        'Mae Hong Son': '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô',
        'Maha Sarakham': '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°',
        Mukdahan: '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£',
        'Nakhon Nayok': '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å',
        'Nakhon Pathom': '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°',
        'Nakhon Phanom': '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°',
        'Nakhon Ratchasima': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
        'Nakhon Sawan': '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå',
        'Nakhon Si Thammarat': '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä',
        Nan: '‡∏ô‡πà‡∏≤‡∏ô',
        Narathiwat: '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™',
        'Nong Bua Lam Phu': '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π',
        'Nong Bua Lamphu': '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π',
        'Nong Khai': '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢',
        Nonthaburi: '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ',
        'Pathum Thani': '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ',
        Pattani: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
        'Phang Nga': '‡∏û‡∏±‡∏á‡∏á‡∏≤',
        Phangnga: '‡∏û‡∏±‡∏á‡∏á‡∏≤',
        Phatthalung: '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á',
        Phayao: '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤',
        Phetchabun: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå',
        Phetchaburi: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ',
        Phichit: '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£',
        Phitsanulok: '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å',
        'Phra Nakhon Si Ayutthaya': '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
        Ayutthaya: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
        Phrae: '‡πÅ‡∏û‡∏£‡πà',
        Phuket: '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',
        'Prachin Buri': '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ',
        Prachinburi: '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ',
        'Prachuap Khiri Khan': '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå',
        Ranong: '‡∏£‡∏∞‡∏ô‡∏≠‡∏á',
        Ratchaburi: '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ',
        Rayong: '‡∏£‡∏∞‡∏¢‡∏≠‡∏á',
        'Roi Et': '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î',
        'Sa Kaeo': '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß',
        'Sakon Nakhon': '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£',
        'Samut Prakan': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£',
        'Samut Sakhon': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£',
        'Samut Songkhram': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°',
        Saraburi: '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ',
        Satun: '‡∏™‡∏ï‡∏π‡∏•',
        'Si Sa Ket': '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©',
        Sisaket: '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©',
        'Sing Buri': '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ',
        Singburi: '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ',
        Songkhla: '‡∏™‡∏á‡∏Ç‡∏•‡∏≤',
        Sukhothai: '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',
        'Suphan Buri': '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ',
        Suphanburi: '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ',
        'Surat Thani': '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ',
        Surin: '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå',
        Tak: '‡∏ï‡∏≤‡∏Å',
        Trang: '‡∏ï‡∏£‡∏±‡∏á',
        Trat: '‡∏ï‡∏£‡∏≤‡∏î',
        'Ubon Ratchathani': '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ',
        'Udon Thani': '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ',
        'Uthai Thani': '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ',
        Uttaradit: '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå',
        Yala: '‡∏¢‡∏∞‡∏•‡∏≤',
        Yasothon: '‡∏¢‡πÇ‡∏™‡∏ò‡∏£',
      };

      // ==================== LOAD PROVINCES ====================
      async function loadProvinces() {
        try {
          const response = await fetch(THAILAND_PROVINCES_URL);
          provincesData = await response.json();

          // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
          provincesData.features = provincesData.features.map((feature) => {
            const props = feature.properties;
            const engName = props.name || props.NAME_1 || '';
            const thaiName = PROVINCE_NAMES_TH[engName] || engName;

            return {
              ...feature,
              properties: {
                ...props,
                name_th: thaiName,
                name_en: engName,
              },
            };
          });

          // ‡πÄ‡∏û‡∏¥‡πà‡∏° source
          map.addSource('thailand-provinces', {
            type: 'geojson',
            data: provincesData,
            generateId: true,
          });

          // ‡∏´‡∏≤ layer ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô label ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° province layers ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ï‡πâ
          const layers = map.getStyle().layers;
          let firstLabelLayerId;
          for (const layer of layers) {
            if (
              layer.type === 'symbol' &&
              layer.layout &&
              layer.layout['text-field']
            ) {
              firstLabelLayerId = layer.id;
              break;
            }
          }

          // Layer 1: Province fill (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö hover/select)
          map.addLayer(
            {
              id: 'province-fill',
              type: 'fill',
              source: 'thailand-provinces',
              paint: {
                'fill-color': [
                  'case',
                  ['boolean', ['feature-state', 'selected'], false],
                  'rgba(211, 47, 47, 0.3)', // Selected - ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô
                  ['boolean', ['feature-state', 'hover'], false],
                  'rgba(211, 47, 47, 0.15)', // Hover - ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏à‡∏≤‡∏á‡πÜ
                  'rgba(255, 255, 255, 0)', // Normal - ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
                ],
              },
            },
            firstLabelLayerId,
          );

          // Layer 2: Province border - ‡∏™‡∏µ‡πÅ‡∏î‡∏á üî¥
          map.addLayer(
            {
              id: 'province-border',
              type: 'line',
              source: 'thailand-provinces',
              paint: {
                'line-color': '#c62828', // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°
                'line-width': [
                  'interpolate',
                  ['linear'],
                  ['zoom'],
                  4,
                  1,
                  6,
                  1.5,
                  10,
                  2.5,
                  14,
                  3,
                ],
                'line-opacity': 0.8,
              },
            },
            firstLabelLayerId,
          );

          // Layer 3: Province border highlight (‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover/select)
          map.addLayer(
            {
              id: 'province-border-highlight',
              type: 'line',
              source: 'thailand-provinces',
              paint: {
                'line-color': '#b71c1c',
                'line-width': [
                  'case',
                  ['boolean', ['feature-state', 'selected'], false],
                  5,
                  ['boolean', ['feature-state', 'hover'], false],
                  4,
                  0,
                ],
              },
            },
            firstLabelLayerId,
          );

          // Layer 4: ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ üìç
          map.addLayer({
            id: 'province-label',
            type: 'symbol',
            source: 'thailand-provinces',
            layout: {
              'text-field': ['get', 'name_th'],
              'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
              'text-size': [
                'interpolate',
                ['linear'],
                ['zoom'],
                4,
                10,
                6,
                13,
                8,
                16,
                10,
                18,
              ],
              'text-anchor': 'center',
              'text-allow-overlap': false,
              'text-ignore-placement': false,
              'text-padding': 5,
            },
            paint: {
              'text-color': '#1a1a1a',
              'text-halo-color': '#ffffff',
              'text-halo-width': 2,
              'text-halo-blur': 0,
            },
          });

          // Setup interactions
          setupProvinceInteractions();
        } catch (error) {
          console.error('Error loading provinces:', error);
        }
      }

      // ==================== PROVINCE INTERACTIONS ====================
      function setupProvinceInteractions() {
        // Mouse move (hover)
        map.on('mousemove', 'province-fill', (e) => {
          if (e.features.length > 0) {
            // Remove old hover
            if (
              hoveredProvinceId !== null &&
              hoveredProvinceId !== selectedProvinceId
            ) {
              map.setFeatureState(
                { source: 'thailand-provinces', id: hoveredProvinceId },
                { hover: false },
              );
            }

            // Set new hover
            hoveredProvinceId = e.features[0].id;
            if (hoveredProvinceId !== selectedProvinceId) {
              map.setFeatureState(
                { source: 'thailand-provinces', id: hoveredProvinceId },
                { hover: true },
              );
            }

            map.getCanvas().style.cursor = 'pointer';

            // Show province stats
            const props = e.features[0].properties;
            const provinceName = props.name_th || props.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
            showProvinceStats(provinceName, e.point.x + 20, e.point.y + 20);
          }
        });

        // Mouse leave
        map.on('mouseleave', 'province-fill', () => {
          if (
            hoveredProvinceId !== null &&
            hoveredProvinceId !== selectedProvinceId
          ) {
            map.setFeatureState(
              { source: 'thailand-provinces', id: hoveredProvinceId },
              { hover: false },
            );
          }
          hideProvinceStats();
          hoveredProvinceId = null;
          map.getCanvas().style.cursor = '';
        });

        // Click (select) - ‡πÑ‡∏°‡πà‡∏°‡∏µ popup, ‡πÅ‡∏Ñ‡πà filter listings
        map.on('click', 'province-fill', (e) => {
          if (e.features.length > 0) {
            // Deselect previous
            if (selectedProvinceId !== null) {
              map.setFeatureState(
                { source: 'thailand-provinces', id: selectedProvinceId },
                { selected: false, hover: false },
              );
            }

            // Select new
            selectedProvinceId = e.features[0].id;
            map.setFeatureState(
              { source: 'thailand-provinces', id: selectedProvinceId },
              { selected: true, hover: false },
            );

            // Get province name (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢)
            const props = e.features[0].properties;
            selectedProvinceName = props.name_th || props.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';

            // Fly to province
            flyToProvince(e.features[0]);

            // Filter listings by province! üéØ
            filterListingsByProvince(selectedProvinceName);
          }
        });
      }

      function flyToProvince(feature) {
        const bounds = new mapboxgl.LngLatBounds();
        const coords = feature.geometry.coordinates;

        if (feature.geometry.type === 'Polygon') {
          coords[0].forEach((coord) => bounds.extend(coord));
        } else if (feature.geometry.type === 'MultiPolygon') {
          coords.forEach((polygon) => {
            polygon[0].forEach((coord) => bounds.extend(coord));
          });
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì center ‡∏Ç‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        const center = bounds.getCenter();

        // üé¨ Fly animation ‡πÅ‡∏ö‡∏ö 3D ‡∏™‡∏ß‡∏¢‡πÜ
        map.flyTo({
          center: center,
          zoom: 9,
          pitch: 55, // ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
          bearing: Math.random() * 30 - 15, // ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
          duration: 2000, // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          essential: true,
          curve: 1.5, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
          easing: (t) => {
            // Smooth easing function
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
          },
        });
      }

      // üîÑ Reset view ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏°‡∏∏‡∏°‡πÄ‡∏î‡∏¥‡∏°
      function resetMapView() {
        // Clear selection
        if (selectedProvinceId !== null) {
          map.setFeatureState(
            { source: 'thailand-provinces', id: selectedProvinceId },
            { selected: false, hover: false },
          );
        }
        selectedProvinceId = null;
        selectedProvinceName = null;

        // Hide province badge
        const badge = document.getElementById('province-badge');
        if (badge) badge.style.display = 'none';

        // Reset listings
        renderListings(properties);
        updateResultCount(properties.length);

        // üé¨ Fly back to Thailand overview
        map.flyTo({
          center: [100.5, 13.5],
          zoom: 5.5,
          pitch: 45,
          bearing: -10,
          duration: 2500,
          essential: true,
        });
      }

      // ==================== FILTER LISTINGS BY PROVINCE ====================
      function filterListingsByProvince(provinceName) {
        // ‡πÅ‡∏™‡∏î‡∏á badge ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        showSelectedProvinceBadge(provinceName);

        // Filter ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≤‡∏Å location)
        const filtered = properties.filter((prop) => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ location ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const location = prop.location.toLowerCase();
          const province = provinceName.toLowerCase();

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ"
          return (
            location.includes(province) ||
            location.includes(province.replace('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')) ||
            matchProvinceKeywords(prop.location, provinceName)
          );
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏µ‡πà filter ‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
        renderListings(filtered);
        updateResultCount(filtered.length, `‡πÉ‡∏ô${provinceName}`);
      }

      function matchProvinceKeywords(location, provinceName) {
        // Map ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô location
        const provinceKeywords = {
          ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ: [
            '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
            '‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô',
            '‡∏û‡∏±‡∏ó‡∏¢‡∏≤',
            '‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤',
            '‡∏ö‡∏≤‡∏á‡∏û‡∏£‡∏∞',
            '‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏∂‡∏á',
            '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡∏ô',
            '‡πÅ‡∏™‡∏ô‡∏™‡∏∏‡∏Ç',
          ],
          ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£: ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', '‡∏Å‡∏ó‡∏°', 'bangkok'],
          ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà: ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', 'chiangmai'],
          ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï: ['‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', 'phuket'],
          ‡∏£‡∏∞‡∏¢‡∏≠‡∏á: ['‡∏£‡∏∞‡∏¢‡∏≠‡∏á', 'rayong'],
          ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£: ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', 'samutprakan'],
          ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ: ['‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', 'nonthaburi'],
          ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ: ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', 'pathumthani'],
        };

        const keywords = provinceKeywords[provinceName] || [provinceName];
        const locationLower = location.toLowerCase();

        return keywords.some((keyword) =>
          locationLower.includes(keyword.toLowerCase()),
        );
      }

      function showSelectedProvinceBadge(provinceName) {
        const container = document.getElementById(
          'selected-province-container',
        );
        container.innerHTML = `
                <div class="selected-province-badge">
                    <i class="material-icons" style="font-size: 16px;">location_on</i>
                    <span>${provinceName}</span>
                    <button class="clear-btn" onclick="clearProvinceFilter()">
                        <i class="material-icons" style="font-size: 14px;">close</i>
                    </button>
                </div>
            `;
      }

      function clearProvinceFilter() {
        // ‡∏•‡∏ö selection ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        if (selectedProvinceId !== null) {
          map.setFeatureState(
            { source: 'thailand-provinces', id: selectedProvinceId },
            { selected: false },
          );
          selectedProvinceId = null;
          selectedProvinceName = null;
        }

        // ‡∏•‡∏ö badge
        document.getElementById('selected-province-container').innerHTML = '';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        renderListings(properties);
        updateResultCount(properties.length);

        // üé¨ Reset map view with 3D animation
        map.flyTo({
          center: [100.5, 13.5],
          zoom: 5.5,
          pitch: 45,
          bearing: -10,
          duration: 2000,
          essential: true,
        });
      }

      // ==================== PROPERTY MARKERS (3D Floating Style) ====================
      function addPropertyMarkers() {
        properties.forEach((prop) => {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á 3D marker structure
          const el = document.createElement('div');
          const isSold = prop.status === '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';

          el.className = `marker-3d ${isSold ? 'sold' : ''}`;
          el.innerHTML = `
                    <div class="marker-tag">${isSold ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : formatPriceShort(prop.price)}</div>
                    <div class="marker-pole"></div>
                    <div class="marker-shadow"></div>
                `;

          el.addEventListener('click', (e) => {
            e.stopPropagation();
            map.flyTo({
              center: [prop.lng, prop.lat],
              zoom: 15,
              pitch: 55,
              duration: 1200,
            });
            setTimeout(() => openPropertyPopup(prop), 600);
          });

          const marker = new mapboxgl.Marker({
            element: el,
            anchor: 'bottom', // ‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î (‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏≤)
          })
            .setLngLat([prop.lng, prop.lat])
            .addTo(map);

          markers[prop.id] = marker;
        });
      }

      function openPropertyPopup(prop) {
        // ‡∏õ‡∏¥‡∏î popup ‡πÄ‡∏Å‡πà‡∏≤
        const popups = document.getElementsByClassName('mapboxgl-popup');
        while (popups.length > 0) {
          popups[0].remove();
        }

        const popupContent = `
                <div class="property-card" style="border:none; box-shadow:none; width: 100%; margin: 0;">
                    <div class="card-image-wrapper" style="height: 140px;">
                        <img src="${prop.images[0]}" alt="${prop.title}" class="card-image">
                        <span class="card-tag ${prop.status === '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' ? 'sold' : ''}">${prop.status}</span>
                    </div>
                    <div class="card-content" style="padding: 12px;">
                        <div class="card-title" style="font-size: 0.95rem;">${prop.title}</div>
                        <div class="card-location" style="margin-bottom: 8px;">
                            <i class="material-icons" style="font-size: 12px;">location_on</i>
                            ${prop.location}
                        </div>
                        <div class="card-price" style="font-size: 1.1rem;">${prop.formattedPrice}</div>
                    </div>
                </div>
            `;

        new mapboxgl.Popup({ closeButton: true, maxWidth: '280px', offset: 25 })
          .setLngLat([prop.lng, prop.lat])
          .setHTML(popupContent)
          .addTo(map);
      }

      // ==================== CONTROLS ====================
      function initControls() {
        document
          .getElementById('btn-reset-view')
          .addEventListener('click', () => {
            clearProvinceFilter();
          });

        document.getElementById('btn-zoom-in').addEventListener('click', () => {
          map.zoomIn();
        });

        document
          .getElementById('btn-zoom-out')
          .addEventListener('click', () => {
            map.zoomOut();
          });
      }

      // ==================== LISTINGS ====================
      function renderListings(data) {
        const grid = document.getElementById('listings-grid');
        grid.innerHTML = '';

        if (data.length === 0) {
          grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #888; grid-column: 1 / -1;">
                        <i class="material-icons" style="font-size: 64px; color: #ddd; margin-bottom: 16px;">search_off</i>
                        <div style="font-size: 18px; font-weight: 500; color: #666; margin-bottom: 8px;">
                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ
                        </div>
                        <div style="font-size: 14px;">
                            ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </div>
                    </div>
                `;
          return;
        }

        data.forEach((prop) => {
          const card = createPropertyCard(prop);
          card.addEventListener('click', () => {
            if (window.map) {
              // üé¨ Fly animation 3D ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å card
              map.flyTo({
                center: [prop.lng, prop.lat],
                zoom: 14,
                pitch: 55,
                bearing: Math.random() * 20 - 10, // ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                duration: 2000,
                essential: true,
              });
              setTimeout(() => {
                openPropertyPopup(prop);
              }, 1000);
            }
          });
          grid.appendChild(card);
        });
      }

      function createPropertyCard(prop) {
        const card = document.createElement('div');
        card.className = 'property-card';
        const isFav = favorites.includes(prop.id);
        card.innerHTML = `
                <div class="card-image-wrapper">
                    <img src="${prop.images[0]}" alt="${prop.title}" class="card-image" data-prop-id="${prop.id}">
                    <span class="card-tag ${prop.status === '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' ? 'sold' : ''}">${prop.status}</span>
                    <button class="favorite-btn ${isFav ? 'active' : ''}" data-prop-id="${prop.id}">
                        <i class="material-icons" style="font-size: 20px;">${isFav ? 'favorite' : 'favorite_border'}</i>
                    </button>
                </div>
                <div class="card-content">
                    <div class="card-title" title="${prop.title}">${prop.title}</div>
                    <div class="card-location">
                        <i class="material-icons" style="font-size: 14px;">location_on</i>
                        ${prop.location}
                    </div>
                    <div class="card-details">
                        <span>${prop.size}</span>
                        <div class="card-divider"></div>
                        <span>${prop.type}</span>
                    </div>
                    <div class="card-price">${prop.formattedPrice}</div>
                </div>
            `;

        // Favorite button handler
        const favBtn = card.querySelector('.favorite-btn');
        favBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleFavorite(prop.id, favBtn);
        });

        // Image click opens gallery
        const img = card.querySelector('.card-image');
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          openGallery(prop);
        });

        return card;
      }

      function updateResultCount(count, suffix = '') {
        const text = suffix
          ? `${count.toLocaleString()} ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ${suffix}`
          : `${count.toLocaleString()} ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå`;
        document.getElementById('result-count-num').textContent = text;
      }

      function formatPriceShort(price) {
        if (price >= 1000000) {
          return `‡∏ø${(price / 1000000).toFixed(1)}M`.replace('.0M', 'M');
        } else if (price >= 1000) {
          return `‡∏ø${(price / 1000).toFixed(0)}K`;
        }
        return `‡∏ø${price}`;
      }

      // ==================== CHATBOT ====================
      function initChatbot() {
        const toggleBtn = document.querySelector('.chatbot-toggle');
        const closeBtn = document.querySelector('.close-chat');
        const messages = document.querySelector('.chatbot-messages');
        const chatInput = document.querySelector('.chat-input input');
        const sendBtn = document.querySelector('.chat-input button');

        if (!toggleBtn || !messages) return;

        toggleBtn.addEventListener('click', () => {
          messages.style.display =
            messages.style.display === 'none' ? 'flex' : 'none';
        });

        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            messages.style.display = 'none';
          });
        }

        // Enable chatbot input
        if (chatInput && sendBtn) {
          chatInput.addEventListener('input', () => {
            sendBtn.disabled = !chatInput.value.trim();
          });

          const handleSend = () => {
            const text = chatInput.value.trim();
            if (!text) return;

            // Add user message
            addChatMessage(text, 'user');
            chatInput.value = '';
            sendBtn.disabled = true;

            // Process and respond
            setTimeout(() => {
              const response = processChatQuery(text);
              addChatMessage(response, 'bot');
            }, 500);
          };

          sendBtn.addEventListener('click', handleSend);
          chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
          });
        }
      }

      function addChatMessage(text, type) {
        const list = document.querySelector('.messages-list');
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.innerHTML =
          type === 'bot'
            ? `<div class="avatar"><img src="https://via.placeholder.com/36" alt="bot"></div><div class="bubble">${text}</div>`
            : `<div class="bubble" style="background: var(--primary-color); color: white; margin-left: auto; border-radius: 12px; border-top-right-radius: 0;">${text}</div>`;
        list.appendChild(msg);
        list.scrollTop = list.scrollHeight;
      }

      function processChatQuery(text) {
        const lower = text.toLowerCase();

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        const provinceMatch = Object.entries(PROVINCE_NAMES_TH).find(
          ([en, th]) =>
            lower.includes(th.toLowerCase()) ||
            lower.includes(en.toLowerCase()),
        );

        if (provinceMatch) {
          const [en, th] = provinceMatch;
          const count = properties.filter(
            (p) =>
              p.location.includes(th) ||
              p.location.toLowerCase().includes(en.toLowerCase()),
          ).length;
          return `‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î${th} ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üè† ‡∏•‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞!`;
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤
        const priceMatch = lower.match(/(\d+)\s*(‡∏•‡πâ‡∏≤‡∏ô|‡πÅ‡∏™‡∏ô)/);
        if (priceMatch) {
          const num = parseInt(priceMatch[1]);
          const unit = priceMatch[2];
          const maxPrice = unit === '‡∏•‡πâ‡∏≤‡∏ô' ? num * 1000000 : num * 100000;
          const found = properties.filter((p) => p.price <= maxPrice);
          return `‡∏û‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${num} ${unit} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${found.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞! üí∞`;
        }

        if (lower.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || lower.includes('‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ')) {
          return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! üòä ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞!';
        }

        return '‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ üôè ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô "‡∏´‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏•‡πâ‡∏≤‡∏ô"';
      }

      // ==================== SEARCH ====================
      function initSearch() {
        const input = document.getElementById('search-input');
        const suggestions = document.getElementById('search-suggestions');

        input.addEventListener('input', (e) => {
          const query = e.target.value.trim().toLowerCase();
          if (query.length < 2) {
            suggestions.classList.remove('active');
            return;
          }

          const results = [];

          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
          Object.entries(PROVINCE_NAMES_TH).forEach(([en, th]) => {
            if (th.includes(query) || en.toLowerCase().includes(query)) {
              results.push({
                type: 'province',
                title: th,
                subtitle: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î',
                icon: 'location_city',
                data: { en, th },
              });
            }
          });

          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
          properties.forEach((prop) => {
            if (
              prop.title.toLowerCase().includes(query) ||
              prop.location.toLowerCase().includes(query)
            ) {
              results.push({
                type: 'property',
                title: prop.title,
                subtitle: prop.location + ' - ' + prop.formattedPrice,
                icon: 'home',
                data: prop,
              });
            }
          });

          if (results.length > 0) {
            suggestions.innerHTML = results
              .slice(0, 8)
              .map(
                (r) => `
                        <div class="suggestion-item" data-type="${r.type}" data-id="${r.data.id || r.data.en}">
                            <i class="material-icons">${r.icon}</i>
                            <div>
                                <div class="title">${r.title}</div>
                                <div class="subtitle">${r.subtitle}</div>
                            </div>
                        </div>
                    `,
              )
              .join('');
            suggestions.classList.add('active');

            // Add click handlers
            suggestions.querySelectorAll('.suggestion-item').forEach((item) => {
              item.addEventListener('click', () => {
                const type = item.dataset.type;
                const id = item.dataset.id;

                if (type === 'province') {
                  // Find and click province on map
                  const th = PROVINCE_NAMES_TH[id];
                  input.value = th;
                  filterListingsByProvince(th);
                } else {
                  // Fly to property
                  const prop = properties.find((p) => p.id == id);
                  if (prop) {
                    input.value = prop.title;
                    map.flyTo({ center: [prop.lng, prop.lat], zoom: 14 });
                    setTimeout(() => openPropertyPopup(prop), 500);
                  }
                }
                suggestions.classList.remove('active');
              });
            });
          } else {
            suggestions.classList.remove('active');
          }
        });

        // Close on click outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.header-center')) {
            suggestions.classList.remove('active');
          }
        });
      }

      // ==================== FILTER ====================
      function initFilter() {
        const toggleBtn = document.getElementById('filter-toggle-btn');
        const panel = document.getElementById('filter-panel');
        const applyBtn = document.getElementById('filter-apply');
        const resetBtn = document.getElementById('filter-reset');

        toggleBtn.addEventListener('click', () => {
          panel.classList.toggle('active');
        });

        applyBtn.addEventListener('click', () => {
          applyFilters();
          panel.classList.remove('active');
        });

        resetBtn.addEventListener('click', () => {
          document.getElementById('filter-type').value = '';
          document.getElementById('filter-status').value = '';
          document.getElementById('filter-source').value = '';
          document.getElementById('filter-price-min').value = '';
          document.getElementById('filter-price-max').value = '';
          filteredProperties = [...properties];
          renderListings(filteredProperties);
          updateResultCount(filteredProperties.length);
        });
      }

      function applyFilters() {
        const type = document.getElementById('filter-type').value;
        const status = document.getElementById('filter-status').value;
        const source = document.getElementById('filter-source').value;
        const priceMin =
          parseInt(document.getElementById('filter-price-min').value) || 0;
        const priceMax =
          parseInt(document.getElementById('filter-price-max').value) ||
          Infinity;

        filteredProperties = properties.filter((prop) => {
          if (type && !prop.title.includes(type) && !prop.type?.includes(type))
            return false;
          if (status && prop.status !== status) return false;
          if (source && !prop.type.includes(source)) return false;
          if (prop.price < priceMin || prop.price > priceMax) return false;
          return true;
        });

        renderListings(filteredProperties);
        updateResultCount(filteredProperties.length);
        updateMarkersVisibility();
      }

      function updateMarkersVisibility() {
        Object.entries(markers).forEach(([id, marker]) => {
          const prop = properties.find((p) => p.id == id);
          const isVisible = filteredProperties.includes(prop);
          marker.getElement().style.display = isVisible ? 'block' : 'none';
        });
      }

      // ==================== DISPLAY SETTINGS ====================
      function initDisplaySettings() {
        const settingsBtn = document.getElementById('display-settings-btn');
        const settingsPanel = document.getElementById('display-settings-panel');
        const closeBtn = document.getElementById('settings-close');
        const styleOptions = document.querySelectorAll('.style-option');
        const presetOptions = document.querySelectorAll('.preset-option');

        // Toggle panel
        settingsBtn.addEventListener('click', () => {
          settingsPanel.classList.toggle('active');
        });

        closeBtn.addEventListener('click', () => {
          settingsPanel.classList.remove('active');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (
            !e.target.closest('.display-settings-panel') &&
            !e.target.closest('.display-settings-btn')
          ) {
            settingsPanel.classList.remove('active');
          }
        });

        // Map Style selection
        styleOptions.forEach((option) => {
          option.addEventListener('click', () => {
            const style = option.dataset.style;
            if (style === currentMapStyle) return;

            // Update UI
            styleOptions.forEach((o) => o.classList.remove('active'));
            option.classList.add('active');

            // Change map style
            currentMapStyle = style;
            const styleUrl =
              style === 'satellite'
                ? 'mapbox://styles/mapbox/standard-satellite'
                : 'mapbox://styles/mapbox/standard';

            // Store current state
            const center = map.getCenter();
            const zoom = map.getZoom();
            const pitch = map.getPitch();
            const bearing = map.getBearing();

            map.setStyle(styleUrl);

            // Restore state and re-add layers after style loads
            map.once('style.load', () => {
              map.setCenter(center);
              map.setZoom(zoom);
              map.setPitch(pitch);
              map.setBearing(bearing);

              // Re-apply light preset
              map.setConfigProperty(
                'basemap',
                'lightPreset',
                currentLightPreset,
              );

              // Re-add terrain
              if (!map.getSource('mapbox-dem')) {
                map.addSource('mapbox-dem', {
                  type: 'raster-dem',
                  url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                  tileSize: 512,
                  maxzoom: 14,
                });
              }
              map.setTerrain({ source: 'mapbox-dem', exaggeration: 2.0 });

              // Re-add sky
              if (!map.getLayer('sky')) {
                map.addLayer({
                  id: 'sky',
                  type: 'sky',
                  paint: {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 90.0],
                    'sky-atmosphere-sun-intensity': 15,
                  },
                });
              }

              // Re-load provinces
              loadProvinces();
            });
          });
        });

        // Light Preset selection
        presetOptions.forEach((option) => {
          option.addEventListener('click', () => {
            const preset = option.dataset.preset;
            if (preset === currentLightPreset) return;

            // Update UI
            presetOptions.forEach((o) => o.classList.remove('active'));
            option.classList.add('active');

            // Change light preset
            currentLightPreset = preset;
            map.setConfigProperty('basemap', 'lightPreset', preset);
          });
        });
      }

      // ==================== PROVINCE STATS ====================
      function showProvinceStats(provinceName, x, y) {
        const tooltip = document.getElementById('province-stats-tooltip');
        const propsInProvince = properties.filter((p) => {
          const loc = p.location.toLowerCase();
          return (
            loc.includes(provinceName.toLowerCase()) ||
            Object.entries(PROVINCE_NAMES_TH).some(
              ([en, th]) =>
                th === provinceName && loc.includes(en.toLowerCase()),
            )
          );
        });

        document.getElementById('stats-province-name').textContent =
          provinceName;
        document.getElementById('stats-count').textContent =
          propsInProvince.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';

        if (propsInProvince.length > 0) {
          const prices = propsInProvince.map((p) => p.price);
          const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
          const min = Math.min(...prices);
          const max = Math.max(...prices);

          document.getElementById('stats-avg').textContent = formatPrice(avg);
          document.getElementById('stats-min').textContent = formatPrice(min);
          document.getElementById('stats-max').textContent = formatPrice(max);
        } else {
          document.getElementById('stats-avg').textContent = '-';
          document.getElementById('stats-min').textContent = '-';
          document.getElementById('stats-max').textContent = '-';
        }

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
        tooltip.classList.add('active');
      }

      function hideProvinceStats() {
        document
          .getElementById('province-stats-tooltip')
          .classList.remove('active');
      }

      function formatPrice(price) {
        if (price >= 1000000) {
          return '‡∏ø' + (price / 1000000).toFixed(1) + 'M';
        }
        return '‡∏ø' + (price / 1000).toFixed(0) + 'K';
      }

      // ==================== FAVORITES ====================
      function toggleFavorite(propId, btn) {
        const index = favorites.indexOf(propId);
        if (index > -1) {
          favorites.splice(index, 1);
          btn.classList.remove('active');
          btn.querySelector('i').textContent = 'favorite_border';
        } else {
          favorites.push(propId);
          btn.classList.add('active');
          btn.querySelector('i').textContent = 'favorite';
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
      }

      // ==================== IMAGE GALLERY ====================
      function openGallery(prop) {
        currentGalleryProperty = prop;
        currentImageIndex = 0;
        updateGalleryImage();
        document.getElementById('gallery-modal').classList.add('active');
      }

      function closeGallery() {
        document.getElementById('gallery-modal').classList.remove('active');
      }

      function updateGalleryImage() {
        const prop = currentGalleryProperty;
        if (!prop) return;

        document.getElementById('gallery-image').src =
          prop.images[currentImageIndex];
        document.getElementById('gallery-title').textContent = prop.title;
        document.getElementById('gallery-location').textContent = prop.location;
        document.getElementById('gallery-price').textContent =
          prop.formattedPrice;
      }

      function nextImage() {
        if (!currentGalleryProperty) return;
        currentImageIndex =
          (currentImageIndex + 1) % currentGalleryProperty.images.length;
        updateGalleryImage();
      }

      function prevImage() {
        if (!currentGalleryProperty) return;
        currentImageIndex =
          (currentImageIndex - 1 + currentGalleryProperty.images.length) %
          currentGalleryProperty.images.length;
        updateGalleryImage();
      }

      // Close gallery on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeGallery();
        if (e.key === 'ArrowRight') nextImage();
        if (e.key === 'ArrowLeft') prevImage();
      });
    </script>
  </body>
</html>
